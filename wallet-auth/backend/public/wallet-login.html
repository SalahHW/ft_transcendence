<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Login with Wallet</title>
</head>

<body>
    <h1>Connexion via MetaMask</h1>
    <button onclick="login()">Se connecter avec MetaMask</button>
    <pre id="result"></pre>

    <!-- ⚠️ CDN Ethers.js DOIT être chargé avant ton script -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        async function login() {
            const result = document.getElementById("result");

            if (!window.ethereum) {
                result.innerText = "MetaMask non détecté";
                return;
            }

            try {
                const provider = new window.ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                const address = await signer.getAddress();

                result.innerText = `Adresse: ${address}\n`;

                // Étape 1: récupérer le message à signer
                const msgRes = await fetch("http://localhost:4000/auth/wallet/request-message", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ address })
                });
                const { message } = await msgRes.json();

                // Étape 2: signature du message
                const signature = await signer.signMessage(message);

                // Étape 3: envoi pour vérification
                const verifyRes = await fetch("http://localhost:4000/auth/wallet/verify", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ address, signature })
                });
                const data = await verifyRes.json();

                result.innerText += `\nAccessToken:\n${data.accessToken || JSON.stringify(data)}`;
            } catch (err) {
                console.error(err);
                result.innerText = "Erreur : " + err.message;
            }
        }
    </script>
</body>

</html>